---
# ============================================================================
# Playbook 1: Base LXC Configuration for K3s
# ============================================================================
# This playbook prepares a Debian 13 LXC container for K3s installation:
# - Critical /dev/kmsg fix (required for kubelet in LXC)
# - Kernel module loading (br_netfilter, overlay)
# - Required package installation
# - System configuration (sysctl)
#
# Usage:
#   export ANSIBLE_LXC_PASSWORD="your_password"
#   ansible-playbook -i inventory/monitoring.yml playbooks/01-base-lxc.yml
#
# Idempotent: Safe to re-run
# ============================================================================

- name: Configure base LXC for K3s
  hosts: k3s_monitor
  become: yes
  gather_facts: yes

  pre_tasks:
    - name: Check for LXC password
      fail:
        msg: "ANSIBLE_LXC_PASSWORD environment variable is required"
      when: lookup('env', 'ANSIBLE_LXC_PASSWORD') == ''
      delegate_to: localhost
      run_once: true

    - name: Wait for LXC to be ready
      wait_for_connection:
        delay: 5
        timeout: 300

    - name: Gather facts after waiting
      setup:

  tasks:
    # ========================================================================
    # CRITICAL: /dev/kmsg fix for kubelet
    # ========================================================================
    - name: Check if /dev/kmsg exists
      stat:
        path: /dev/kmsg
      register: kmsg_check

    - name: Create /dev/kmsg symlink if missing
      file:
        src: /dev/console
        dest: /dev/kmsg
        state: link
      when: not kmsg_check.stat.exists

    - name: Create persistent kmsg fix script
      copy:
        dest: /usr/local/bin/conf-kmsg.sh
        mode: '0755'
        content: |
          #!/bin/sh
          # Ensure /dev/kmsg exists for kubelet
          if [ ! -e /dev/kmsg ]; then
            ln -s /dev/console /dev/kmsg
          fi

    - name: Create systemd service for kmsg fix
      copy:
        dest: /etc/systemd/system/conf-kmsg.service
        content: |
          [Unit]
          Description=Ensure /dev/kmsg exists for kubelet
          DefaultDependencies=no
          After=local-fs.target

          [Service]
          Type=oneshot
          ExecStart=/usr/local/bin/conf-kmsg.sh
          RemainAfterExit=yes

          [Install]
          WantedBy=multi-user.target
      register: kmsg_service

    - name: Enable and start kmsg service
      systemd:
        name: conf-kmsg
        enabled: yes
        state: started
        daemon_reload: "{{ kmsg_service.changed }}"

    # ========================================================================
    # Kernel modules for K3s
    # ========================================================================
    # Note: Kernel modules must be loaded on Proxmox host, not inside LXC
    # LXC shares the host kernel, so modules loaded on host are available
    - name: Load required kernel modules
      community.general.modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - br_netfilter
        - overlay
      ignore_errors: yes  # LXC may not have access to modprobe files

    - name: Persist kernel modules
      copy:
        dest: /etc/modules-load.d/k3s.conf
        content: |
          br_netfilter
          overlay

    # ========================================================================
    # System configuration
    # ========================================================================
    - name: Configure sysctl for K3s
      sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        state: present
        reload: yes
        sysctl_file: /etc/sysctl.d/k3s.conf
      loop:
        - { key: 'net.bridge.bridge-nf-call-iptables', value: '1' }
        - { key: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
        - { key: 'net.ipv4.ip_forward', value: '1' }

    # ========================================================================
    # Package installation
    # ========================================================================
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      apt:
        name:
          - curl
          - wget
          - ca-certificates
          - gnupg
          - nfs-common
          - iptables
          - open-iscsi
          - util-linux
        state: present

    # ========================================================================
    # SSH hardening (optional)
    # ========================================================================
    - name: Ensure SSH permits root login
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PermitRootLogin'
        line: 'PermitRootLogin yes'
        state: present
      notify: Restart SSH

  handlers:
    - name: Restart SSH
      systemd:
        name: ssh
        state: restarted

  post_tasks:
    - name: Display configuration summary
      debug:
        msg:
          - "=========================================="
          - "Base LXC configuration complete!"
          - "=========================================="
          - "/dev/kmsg: {{ 'Fixed and persistent' if not kmsg_check.stat.exists else 'Already exists' }}"
          - "Kernel modules: br_netfilter, overlay loaded"
          - "Required packages: Installed"
          - "LXC is ready for K3s installation"
          - ""
          - "Next step: ansible-playbook -i inventory/monitoring.yml playbooks/02-k3s-install.yml"
