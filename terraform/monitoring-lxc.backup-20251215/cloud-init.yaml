#cloud-config

# K3s Monitoring Cluster - Cloud-Init Configuration
# Managed by Terraform - stored on Proxmox local storage

hostname: k3s-monitor
fqdn: k3s-monitor.local
timezone: UTC

# Root user configuration
users:
  - name: root
    lock_passwd: false
    ssh_authorized_keys: []

# SSH configuration
ssh_pwauth: true
disable_root: false

# Package management
package_update: true
package_upgrade: true

packages:
  - curl
  - wget
  - ca-certificates
  - nfs-common
  - iptables

# Kernel modules (loaded on Proxmox host, referenced here)
bootcmd:
  - echo "Kernel modules should be loaded on Proxmox host"

# K3s installation
runcmd:
  # Wait for network and system initialization
  - sleep 15

  # Install K3s with LXC-optimized settings
  - |
    export INSTALL_K3S_EXEC="server \
      --disable=traefik \
      --disable=servicelb \
      --disable=local-storage \
      --flannel-backend=host-gw \
      --write-kubeconfig-mode=644"
  - curl -sfL https://get.k3s.io | sh -s -

  # Wait for K3s API server to be ready
  - timeout 120 bash -c 'until k3s kubectl get nodes 2>/dev/null | grep -q Ready; do echo "Waiting for K3s API..."; sleep 5; done'

  # Fix kubeconfig server address
  - sed -i 's|https://127.0.0.1:6443|https://10.30.0.20:6443|g' /etc/rancher/k3s/k3s.yaml
  - chmod 644 /etc/rancher/k3s/k3s.yaml

  # Create root kubeconfig
  - mkdir -p /root/.kube
  - cp /etc/rancher/k3s/k3s.yaml /root/.kube/config
  - chmod 600 /root/.kube/config

  # Verification
  - k3s kubectl get nodes
  - echo "K3s installation complete - $(date)" >> /var/log/cloud-init-k3s.log

# SSH configuration file
write_files:
  - path: /etc/ssh/sshd_config.d/99-cloud-init.conf
    content: |
      PasswordAuthentication yes
      PermitRootLogin yes
      PubkeyAuthentication yes
    permissions: '0644'

final_message: "K3s monitoring cluster initialized successfully after $UPTIME seconds"
