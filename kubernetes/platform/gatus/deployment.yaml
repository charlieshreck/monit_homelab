---
apiVersion: v1
kind: ConfigMap
metadata:
  name: gatus-config
  namespace: monitoring
data:
  config.yaml: |
    storage:
      type: sqlite
      path: /data/data.db

    metrics: true

    ui:
      title: "Homelab Status"
      header: "Monitoring Dashboard"

    # Alert forwarding to LangGraph incident broker
    alerting:
      custom:
        url: "http://10.20.0.40:30800/ingest?source=gatus"
        method: "POST"
        headers:
          Content-Type: application/json
        body: |
          {
            "endpoint_name": "[ENDPOINT_NAME]",
            "endpoint_group": "[ENDPOINT_GROUP]",
            "endpoint_url": "[ENDPOINT_URL]",
            "success": [ALERT_TRIGGERED_OR_RESOLVED],
            "description": "[ENDPOINT_NAME] ([ENDPOINT_GROUP]) health check failed: [RESULT_ERRORS]",
            "condition_results": "[RESULT_CONDITIONS]"
          }
        placeholders:
          ALERT_TRIGGERED_OR_RESOLVED:
            TRIGGERED: "false"
            RESOLVED: "true"
        default-alert:
          enabled: true
          failure-threshold: 3
          success-threshold: 2
          send-on-resolved: true

    endpoints:
      # Storage
      - name: Garage S3 API
        group: Storage
        url: "http://10.20.0.103:30188"
        interval: 60s
        conditions:
          - "[STATUS] == 403"  # Anonymous requests return 403
        client:
          insecure: true

      - name: Garage Web UI
        group: Storage
        url: "http://10.20.0.103:30186"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Backrest
        group: Storage
        url: "http://backrest.backrest.svc:9898"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      # Infrastructure
      - name: Proxmox Ruapehu (Production)
        group: Infrastructure
        url: "https://10.10.0.10:8006"
        interval: 120s
        conditions:
          - "[STATUS] == 200"
        client:
          insecure: true

      - name: Proxmox Pihanga (Monitoring)
        group: Infrastructure
        url: "https://10.10.0.20:8006"
        interval: 120s
        conditions:
          - "[STATUS] == 200"
        client:
          insecure: true

      - name: Production Talos Cluster
        group: Infrastructure
        url: "https://10.10.0.40:6443"
        interval: 60s
        conditions:
          - "[STATUS] == 401"
        client:
          insecure: true

      - name: Monitoring Talos Cluster
        group: Infrastructure
        url: "https://10.10.0.30:6443"
        interval: 60s
        conditions:
          - "[STATUS] == 401"
        client:
          insecure: true

      - name: Production Traefik
        group: Infrastructure
        url: "http://10.10.0.90:80"
        interval: 60s
        conditions:
          - "[STATUS] == 404"

      - name: Agentic Talos Cluster
        group: Infrastructure
        url: "https://10.20.0.40:6443"
        interval: 60s
        conditions:
          - "[STATUS] == 401"
        client:
          insecure: true

      - name: Coroot
        group: Monitoring
        url: "http://coroot-coroot.coroot.svc:8080"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      # MCP Servers — 6 consolidated domain MCPs (DNS ingress)
      - name: Observability MCP
        group: MCP Servers
        url: "http://observability-mcp.agentic.kernow.io/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Infrastructure MCP
        group: MCP Servers
        url: "http://infrastructure-mcp.agentic.kernow.io/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Knowledge MCP
        group: MCP Servers
        url: "http://knowledge-mcp.agentic.kernow.io/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Home MCP
        group: MCP Servers
        url: "http://home-mcp.agentic.kernow.io/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Media MCP
        group: MCP Servers
        url: "http://media-mcp.agentic.kernow.io/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: External MCP
        group: MCP Servers
        url: "http://external-mcp.agentic.kernow.io/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      # Storage — TrueNAS health checks
      - name: PBS (Backup Server)
        group: Infrastructure
        url: "https://10.10.0.151:8007"
        interval: 120s
        conditions:
          - "[STATUS] == 200"
        client:
          insecure: true

      - name: TrueNAS HDD
        group: Storage
        url: "https://10.20.0.103:443"
        interval: 120s
        conditions:
          - "[STATUS] == 200"
        client:
          insecure: true

      - name: TrueNAS Media
        group: Storage
        url: "https://10.20.0.100:443"
        interval: 120s
        conditions:
          - "[STATUS] == 200"
        client:
          insecure: true

      # Network — AdGuard health check (HTTP instead of DNS due to firewall)
      - name: AdGuard Home
        group: Network
        url: "http://10.10.0.1:3000"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      # AI Platform (Local Inference)
      - name: Ollama (qwen2.5:7b)
        group: AI Platform
        url: "http://10.20.0.40:31434/"
        interval: 30s
        conditions:
          - "[STATUS] == 200"

      - name: LiteLLM Proxy
        group: AI Platform
        url: "http://10.20.0.40:31400/health"
        interval: 30s
        conditions:
          - "[STATUS] == 200"

      - name: LangGraph Orchestrator
        group: AI Platform
        url: "http://10.20.0.40:31095/health"
        interval: 30s
        conditions:
          - "[STATUS] == 200"

      - name: Matrix Bot
        group: AI Platform
        url: "http://10.20.0.40:31102/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      # Monitoring Stack (using internal service names)
      - name: Grafana
        group: Monitoring
        url: "http://kube-prometheus-stack-grafana.monitoring:80/api/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Prometheus
        group: Monitoring
        url: "http://kube-prometheus-stack-prometheus.monitoring:9090/-/healthy"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Alertmanager
        group: Monitoring
        url: "http://kube-prometheus-stack-alertmanager.monitoring:9093/-/healthy"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: VictoriaMetrics
        group: Monitoring
        url: "http://victoria-metrics-victoria-metrics-single-server.monitoring:8428/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: VictoriaLogs
        group: Monitoring
        url: "http://victoria-logs-victoria-logs-single-server.monitoring:9428/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Gatus (This)
        group: Monitoring
        url: "http://gatus.monitoring:8080"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Beszel
        group: Monitoring
        url: "http://beszel.monitoring:8090"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      # Core Applications
      - name: Homepage
        group: Apps
        url: "https://homepage.kernow.io"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: ArgoCD
        group: Apps
        url: "https://argocd.kernow.io"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Vaultwarden
        group: Apps
        url: "https://vaultwarden.kernow.io"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: FileBrowser
        group: Apps
        url: "https://files.kernow.io"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Termix
        group: Apps
        url: "https://termix.kernow.io"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      # Home Automation
      - name: Home Assistant
        group: Home Automation
        url: "https://homeassistant.kernow.io"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Matter Hub
        group: Home Automation
        url: "https://matter-hub.kernow.io"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: TasmoAdmin
        group: Home Automation
        url: "https://tasmoadmin.kernow.io"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      # Media Stack
      - name: Overseerr
        group: Media
        url: "https://overseerr.kernow.io"
        interval: 120s
        conditions:
          - "[STATUS] == 200"

      - name: Radarr
        group: Media
        url: "https://radarr.kernow.io"
        interval: 120s
        conditions:
          - "[STATUS] == 200"

      - name: Sonarr
        group: Media
        url: "https://sonarr.kernow.io"
        interval: 120s
        conditions:
          - "[STATUS] == 200"

      - name: Prowlarr
        group: Media
        url: "https://prowlarr.kernow.io"
        interval: 120s
        conditions:
          - "[STATUS] == 200"

      - name: SABnzbd
        group: Media
        url: "https://sabnzbd.kernow.io"
        interval: 120s
        conditions:
          - "[STATUS] == 200"

      - name: Transmission
        group: Media
        url: "https://transmission.kernow.io"
        interval: 120s
        conditions:
          - "[STATUS] == 200"

      - name: Tautulli
        group: Media
        url: "https://tautulli.kernow.io"
        interval: 120s
        conditions:
          - "[STATUS] < 400"
        client:
          ignore-redirect: true

      - name: Cleanuparr
        group: Media
        url: "https://cleanuparr.kernow.io"
        interval: 120s
        conditions:
          - "[STATUS] == 200"

      # Notes Apps
      - name: GlassKeep
        group: Notes
        url: "https://glasskeep.kernow.io"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: KaraKeep
        group: Notes
        url: "https://karakeep.kernow.io"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Outline
        group: Notes
        url: "https://outline.kernow.io"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      # Control LXC (Synapse)
      - name: Afferent (Claude Code Mobile)
        group: Infrastructure
        url: "http://10.10.0.22:3456"
        interval: 60s
        conditions:
          - "[STATUS] == 200"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gatus-data
  namespace: monitoring
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gatus
  namespace: monitoring
  labels:
    app: gatus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gatus
  template:
    metadata:
      labels:
        app: gatus
    spec:
      containers:
        - name: gatus
          image: twinproduction/gatus:latest
          ports:
            - name: web
              containerPort: 8080
              protocol: TCP
          volumeMounts:
            - name: config
              mountPath: /config
            - name: data
              mountPath: /data
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi
      volumes:
        - name: config
          configMap:
            name: gatus-config
        - name: data
          persistentVolumeClaim:
            claimName: gatus-data
---
apiVersion: v1
kind: Service
metadata:
  name: gatus
  namespace: monitoring
spec:
  selector:
    app: gatus
  ports:
    - name: web
      protocol: TCP
      port: 8080
      targetPort: 8080
  type: ClusterIP
