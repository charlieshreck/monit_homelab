---
apiVersion: v1
kind: ConfigMap
metadata:
  name: gatus-config
  namespace: monitoring
data:
  config.yaml: |
    storage:
      type: sqlite
      path: /data/data.db

    metrics: true

    ui:
      title: "Homelab Status"
      header: "Monitoring Dashboard"

    # Alert forwarding to Keep alert aggregation platform
    alerting:
      custom:
        url: "http://10.20.0.40:31105/alerts/event"
        method: "POST"
        headers:
          Content-Type: application/json
          X-API-KEY: 2590dbe6-64f6-4c0a-be76-4d0ccefb79a4
        body: |
          {
            "name": "[ENDPOINT_NAME]",
            "status": "[ALERT_TRIGGERED_OR_RESOLVED]",
            "source": ["gatus"],
            "labels": {
              "group": "[ENDPOINT_GROUP]",
              "endpoint": "[ENDPOINT_NAME]"
            },
            "description": "[ENDPOINT_NAME] health check [ALERT_TRIGGERED_OR_RESOLVED]",
            "severity": "warning"
          }
        default-alert:
          enabled: true
          failure-threshold: 3
          success-threshold: 2
          send-on-resolved: true

    endpoints:
      # Infrastructure
      - name: Proxmox Ruapehu (Production)
        group: Infrastructure
        url: "https://10.10.0.10:8006"
        interval: 120s
        conditions:
          - "[STATUS] == 200"
        client:
          insecure: true

      - name: Proxmox Carrick (Monitoring)
        group: Infrastructure
        url: "https://10.30.0.10:8006"
        interval: 120s
        conditions:
          - "[STATUS] == 200"
        client:
          insecure: true

      - name: Production Talos Cluster
        group: Infrastructure
        url: "https://10.10.0.40:6443"
        interval: 60s
        conditions:
          - "[STATUS] == 401"
        client:
          insecure: true

      - name: Monitoring K3s Cluster
        group: Infrastructure
        url: "https://10.30.0.20:6443"
        interval: 60s
        conditions:
          - "[STATUS] == 401"
        client:
          insecure: true

      - name: Production Traefik
        group: Infrastructure
        url: "http://10.10.0.90:80"
        interval: 60s
        conditions:
          - "[STATUS] == 404"

      - name: Agentic Talos Cluster
        group: Infrastructure
        url: "https://10.20.0.40:6443"
        interval: 60s
        conditions:
          - "[STATUS] == 401"
        client:
          insecure: true

      - name: Coroot
        group: Monitoring
        url: "http://10.30.0.20:32702"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      # MCP Servers (Agentic Cluster)
      - name: Infisical MCP
        group: MCP Servers
        url: "http://10.20.0.40:31080/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Coroot MCP
        group: MCP Servers
        url: "http://10.20.0.40:31081/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Proxmox MCP
        group: MCP Servers
        url: "http://10.20.0.40:31082/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Infrastructure MCP
        group: MCP Servers
        url: "http://10.20.0.40:31083/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Knowledge MCP
        group: MCP Servers
        url: "http://10.20.0.40:31084/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: OPNsense MCP
        group: MCP Servers
        url: "http://10.20.0.40:31085/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: AdGuard MCP
        group: MCP Servers
        url: "http://10.20.0.40:31086/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Cloudflare MCP
        group: MCP Servers
        url: "http://10.20.0.40:31087/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: UniFi MCP
        group: MCP Servers
        url: "http://10.20.0.40:31088/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: TrueNAS MCP
        group: MCP Servers
        url: "http://10.20.0.40:31089/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Home Assistant MCP
        group: MCP Servers
        url: "http://10.20.0.40:31090/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Arr Suite MCP
        group: MCP Servers
        url: "http://10.20.0.40:31091/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Homepage MCP
        group: MCP Servers
        url: "http://10.20.0.40:31092/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Web Search MCP
        group: MCP Servers
        url: "http://10.20.0.40:31093/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Browser Automation MCP
        group: MCP Servers
        url: "http://10.20.0.40:31094/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Plex MCP
        group: MCP Servers
        url: "http://10.20.0.40:31096/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Vikunja MCP
        group: MCP Servers
        url: "http://10.20.0.40:31097/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      # Monitoring Stack (using internal service names)
      - name: Grafana
        group: Monitoring
        url: "http://kube-prometheus-stack-grafana.monitoring:80/api/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Prometheus
        group: Monitoring
        url: "http://kube-prometheus-stack-prometheus.monitoring:9090/-/healthy"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Alertmanager
        group: Monitoring
        url: "http://kube-prometheus-stack-alertmanager.monitoring:9093/-/healthy"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: VictoriaMetrics
        group: Monitoring
        url: "http://victoria-metrics-victoria-metrics-single-server.monitoring:8428/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: VictoriaLogs
        group: Monitoring
        url: "http://victoria-logs-victoria-logs-single-server.monitoring:9428/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Gatus (This)
        group: Monitoring
        url: "http://gatus.monitoring:8080"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Beszel
        group: Monitoring
        url: "http://beszel.monitoring:8090"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      # Core Applications
      - name: Homepage
        group: Apps
        url: "https://homepage.kernow.io"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: ArgoCD
        group: Apps
        url: "https://argocd.kernow.io"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Vaultwarden
        group: Apps
        url: "https://vaultwarden.kernow.io"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: FileBrowser
        group: Apps
        url: "https://files.kernow.io"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Termix
        group: Apps
        url: "https://termix.kernow.io"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      # Home Automation
      - name: Home Assistant
        group: Home Automation
        url: "https://homeassistant.kernow.io"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Matter Hub
        group: Home Automation
        url: "https://matter-hub.kernow.io"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: TasmoAdmin
        group: Home Automation
        url: "https://tasmoadmin.kernow.io"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      # Media Stack
      - name: Overseerr
        group: Media
        url: "https://overseerr.kernow.io"
        interval: 120s
        conditions:
          - "[STATUS] == 200"

      - name: Radarr
        group: Media
        url: "https://radarr.kernow.io"
        interval: 120s
        conditions:
          - "[STATUS] == 200"

      - name: Sonarr
        group: Media
        url: "https://sonarr.kernow.io"
        interval: 120s
        conditions:
          - "[STATUS] == 200"

      - name: Prowlarr
        group: Media
        url: "https://prowlarr.kernow.io"
        interval: 120s
        conditions:
          - "[STATUS] == 200"

      - name: SABnzbd
        group: Media
        url: "https://sabnzbd.kernow.io"
        interval: 120s
        conditions:
          - "[STATUS] == 200"

      - name: Transmission
        group: Media
        url: "https://transmission.kernow.io"
        interval: 120s
        conditions:
          - "[STATUS] == 200"

      - name: Tautulli
        group: Media
        url: "https://tautulli.kernow.io"
        interval: 120s
        conditions:
          - "[STATUS] == 200"

      - name: Cleanuparr
        group: Media
        url: "https://cleanuparr.kernow.io"
        interval: 120s
        conditions:
          - "[STATUS] == 200"

      # Notes Apps
      - name: GlassKeep
        group: Notes
        url: "https://glasskeep.kernow.io"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: KaraKeep
        group: Notes
        url: "https://karakeep.kernow.io"
        interval: 60s
        conditions:
          - "[STATUS] == 200"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gatus-data
  namespace: monitoring
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gatus
  namespace: monitoring
  labels:
    app: gatus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gatus
  template:
    metadata:
      labels:
        app: gatus
    spec:
      containers:
        - name: gatus
          image: twinproduction/gatus:latest
          ports:
            - name: web
              containerPort: 8080
              protocol: TCP
          volumeMounts:
            - name: config
              mountPath: /config
            - name: data
              mountPath: /data
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi
      volumes:
        - name: config
          configMap:
            name: gatus-config
        - name: data
          persistentVolumeClaim:
            claimName: gatus-data
---
apiVersion: v1
kind: Service
metadata:
  name: gatus
  namespace: monitoring
spec:
  selector:
    app: gatus
  ports:
    - name: web
      protocol: TCP
      port: 8080
      targetPort: 8080
      nodePort: 32080  # External access for cross-cluster queries
  type: NodePort
