---
apiVersion: v1
kind: ConfigMap
metadata:
  name: gatus-config
  namespace: monitoring
data:
  config.yaml: |
    storage:
      type: sqlite
      path: /data/data.db

    metrics: true

    ui:
      title: "Homelab Status"
      header: "Monitoring Dashboard"

    endpoints:
      # Production Cluster Services
      - name: Production Talos API
        url: "https://10.10.0.40:6443"
        interval: 60s
        conditions:
          - "[STATUS] == 200"
        client:
          insecure: true

      - name: Production Traefik
        url: "http://10.10.0.90:80"
        interval: 60s
        conditions:
          - "[STATUS] == 404"  # Traefik returns 404 on root, which is expected

      # Monitoring Cluster
      - name: Monitoring K3s
        url: "https://10.30.0.20:6443"
        interval: 60s
        conditions:
          - "[STATUS] == 200"
        client:
          insecure: true

      # Proxmox Hosts
      - name: Proxmox Ruapehu
        url: "https://10.10.0.10:8006"
        interval: 120s
        conditions:
          - "[STATUS] == 200"
        client:
          insecure: true

      - name: Proxmox Carrick
        url: "https://10.30.0.10:8006"
        interval: 120s
        conditions:
          - "[STATUS] == 200"
        client:
          insecure: true

      # Monitoring Stack
      - name: Prometheus
        url: "http://kube-prometheus-stack-prometheus.monitoring:9090/-/healthy"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: Grafana
        url: "http://kube-prometheus-stack-grafana.monitoring:80/api/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: VictoriaMetrics
        url: "http://victoria-metrics.monitoring:8428/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"

      - name: VictoriaLogs
        url: "http://victoria-logs.monitoring:9428/health"
        interval: 60s
        conditions:
          - "[STATUS] == 200"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gatus-data
  namespace: monitoring
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gatus
  namespace: monitoring
  labels:
    app: gatus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gatus
  template:
    metadata:
      labels:
        app: gatus
    spec:
      containers:
        - name: gatus
          image: twinproduction/gatus:latest
          ports:
            - name: web
              containerPort: 8080
              protocol: TCP
          volumeMounts:
            - name: config
              mountPath: /config
            - name: data
              mountPath: /data
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi
      volumes:
        - name: config
          configMap:
            name: gatus-config
        - name: data
          persistentVolumeClaim:
            claimName: gatus-data
---
apiVersion: v1
kind: Service
metadata:
  name: gatus
  namespace: monitoring
spec:
  selector:
    app: gatus
  ports:
    - name: web
      protocol: TCP
      port: 8080
      targetPort: 8080
  type: ClusterIP
