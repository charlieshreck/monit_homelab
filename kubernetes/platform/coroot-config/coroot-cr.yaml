---
# Coroot Custom Resource - Integrated with Victoria Metrics
# External Prometheus eliminates duplicate metric storage
# ClickHouse only for eBPF-specific data (traces, profiles, logs)
apiVersion: coroot.com/v1
kind: Coroot
metadata:
  name: coroot
  namespace: coroot
spec:
  # Enable anonymous read-only access for MCP API queries
  authAnonymousRole: Viewer

  # CRITICAL: Use Victoria Metrics as external Prometheus data source
  externalPrometheus:
    url: "http://victoria-metrics-victoria-metrics-single-server.monitoring:8428"
    tlsSkipVerify: false

  # ClickHouse configuration - REDUCED storage (only eBPF data, not metrics)
  clickhouse:
    replicas: 1
    shards: 1
    keeper:
      storage:
        size: 10Gi  # Coordination data
    storage:
      size: 100Gi  # REDUCED: Only traces/profiles/eBPF logs

  # Coroot server configuration
  storage:
    size: 10Gi

  # ClusterIP service - accessed via Traefik ingress
  service:
    type: ClusterIP

  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 2Gi

  # Cluster agent configuration (monitoring cluster only)
  clusterAgent:
    env:
      - name: API_KEY
        valueFrom:
          secretKeyRef:
            name: monit-homelab-api-key
            key: apikey

  # Projects for multi-cluster monitoring
  projects:
    - name: prod-homelab
      apiKeys:
        - description: "Production cluster agents"
          keySecret:
            name: prod-homelab-api-key
            key: apikey

    - name: monit-homelab
      apiKeys:
        - description: "Monitoring cluster agents"
          keySecret:
            name: monit-homelab-api-key
            key: apikey

    - name: agentic-homelab
      apiKeys:
        - description: "Agentic cluster agents"
          keySecret:
            name: agentic-homelab-api-key
            key: apikey

    - name: all-clusters
      memberProjects:
        - prod-homelab
        - monit-homelab
        - agentic-homelab
      notificationIntegrations:
        baseURL: "https://coroot.kernow.io"
        webhook:
          url: "http://10.20.0.40:30800/ingest?source=coroot"
          incidents: true
          deployments: false
          incidentTemplate: |
            {
              "title": "{{ .Application.Name }}@{{ .Application.Namespace }}",
              "severity": "{{ if eq .Status "CRITICAL" }}critical{{ else if eq .Status "WARNING" }}warning{{ else }}info{{ end }}",
              "text": "{{ range .Reports }}{{ .Check }}: {{ .Message }} {{ end }}",
              "application": "{{ .Application.Name }}",
              "namespace": "{{ .Application.Namespace }}",
              "url": "{{ .URL }}",
              "status": "{{ .Status }}"
            }
          deploymentTemplate: |
            {
              "title": "Deployment: {{ .Application.Name }}",
              "severity": "info",
              "text": "Deployment {{ .Version }}: {{ .Status }}",
              "application": "{{ .Application.Name }}",
              "namespace": "{{ .Application.Namespace }}",
              "status": "{{ .Status }}"
            }
