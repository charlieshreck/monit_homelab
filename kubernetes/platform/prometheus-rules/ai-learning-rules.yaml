---
# AI Learning System PrometheusRule
# Part of Forever Learning System - Phase 4
# CAB Condition: Must have alerts for learning system health
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: ai-learning-rules
  namespace: monitoring
  labels:
    app: kube-prometheus-stack
    release: kube-prometheus-stack
spec:
  groups:
    - name: ai-learning
      rules:
        # CAB Condition: Alert if no new events logged in 24h
        - alert: LearningSystemStale
          expr: |
            (time() - claude_agent_events_logged_created{success="true"}) > 86400
          for: 30m
          labels:
            severity: warning
            team: ai-platform
          annotations:
            summary: "AI Learning System has not logged events in 24+ hours"
            description: "No new events have been logged to the knowledge base in over 24 hours. The learning system may be stale or broken."
            runbook_url: "https://docs.kernow.io/runbooks/learning-system-stale"

        # NOTE: LowFeedbackScore alert REMOVED - claude-validator service decommissioned.
        # Re-add when validator metrics are available from a new service.

        # Alert on high task failure rate
        - alert: HighTaskFailureRate
          expr: |
            (
              sum(rate(claude_agent_tasks_total{status=~"failed|error"}[1h])) /
              sum(rate(claude_agent_tasks_total[1h]))
            ) > 0.3
          for: 30m
          labels:
            severity: warning
            team: ai-platform
          annotations:
            summary: "High rate of AI task failures"
            description: "{{ $value | humanizePercentage }} of tasks are failing in the last hour. Check claude-agent logs for errors."
            runbook_url: "https://docs.kernow.io/runbooks/high-task-failure-rate"

        # Alert if queue is backing up
        - alert: TaskQueueBacklog
          expr: |
            claude_agent_queue_size > 10
          for: 15m
          labels:
            severity: warning
            team: ai-platform
          annotations:
            summary: "AI task queue has significant backlog"
            description: "{{ $value }} tasks waiting in queue. Workers may be overwhelmed or stuck."
            runbook_url: "https://docs.kernow.io/runbooks/task-queue-backlog"

        # Alert if no active workers
        - alert: NoActiveWorkers
          expr: |
            claude_agent_active_workers == 0
          for: 5m
          labels:
            severity: critical
            team: ai-platform
          annotations:
            summary: "No active AI workers"
            description: "All claude-agent workers have stopped. Task processing is halted."
            runbook_url: "https://docs.kernow.io/runbooks/no-active-workers"

        # Alert on slow task execution
        - alert: SlowTaskExecution
          expr: |
            histogram_quantile(0.95, rate(claude_agent_task_duration_seconds_bucket[1h])) > 300
          for: 30m
          labels:
            severity: warning
            team: ai-platform
          annotations:
            summary: "AI tasks taking too long"
            description: "P95 task duration is {{ $value | humanizeDuration }}. Tasks may be timing out."
            runbook_url: "https://docs.kernow.io/runbooks/slow-task-execution"

        # NOTE: LowFeedbackVolume alert REMOVED - claude-validator service decommissioned.
        # Re-add when validator metrics are available from a new service.
