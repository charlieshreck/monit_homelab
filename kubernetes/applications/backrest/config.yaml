---
# Initial Backrest configuration ConfigMap
# This is used to bootstrap the config on first run via init container
apiVersion: v1
kind: ConfigMap
metadata:
  name: backrest-initial-config
  namespace: backrest
data:
  config.json: |
    {
      "modno": 1,
      "version": 4,
      "instance": "kernow-backup",
      "repos": [
        {
          "id": "garage-s3",
          "uri": "s3:http://10.10.0.103:30188/backrest",
          "guid": "ca2231ad6f43e4f64124d4abcde0774e9b1eeca5dea0c9afbafc76277b8df146",
          "password": "0kbiHiNLqevgMpWAb1y8yMR3vy6qmWuCiTu/5hiVpEwA2s5j",
          "prunePolicy": {
            "schedule": {
              "cron": "0 0 1 * *",
              "clock": "CLOCK_LAST_RUN_TIME"
            },
            "maxUnusedPercent": 10
          },
          "checkPolicy": {
            "schedule": {
              "cron": "0 0 1 * *",
              "clock": "CLOCK_LAST_RUN_TIME"
            }
          },
          "autoUnlock": true,
          "commandPrefix": {},
          "hooks": [
            {
              "conditions": ["CONDITION_ANY_ERROR"],
              "action": {
                "actionShoutrrr": {
                  "shoutrrrUrl": "generic://X-API-KEY:16b7de2a-5d6d-4021-a774-53a083edc28e@10.20.0.40:31105/alerts/event/webhook?disabletls=yes&template=json&titlekey=name&messagekey=description&$severity=warning&$source=backrest"
                }
              }
            }
          ]
        }
      ],
      "plans": [
        {
          "id": "plex-daily",
          "repo": "garage-s3",
          "paths": [
            "/opt/plex/config/Library/Application Support/Plex Media Server",
            "/opt/plex/compose"
          ],
          "excludes": [
            "/opt/plex/config/Library/Application Support/Plex Media Server/Cache",
            "/opt/plex/config/Library/Application Support/Plex Media Server/Logs"
          ],
          "schedule": {
            "cron": "0 4 * * *",
            "clock": "CLOCK_LOCAL"
          },
          "retention": {
            "policyTimeBucketed": {
              "daily": 7,
              "weekly": 4
            }
          },
          "backupFlags": ["--tag", "plex"],
          "commandPrefix": {
            "backup": ["ssh", "-o", "StrictHostKeyChecking=no", "root@10.10.0.50"]
          }
        },
        {
          "id": "iac-daily",
          "repo": "garage-s3",
          "paths": ["/home", "/root", "/etc"],
          "excludes": ["/root/.cache", "/home/*/.cache", "/root/.local/share/nvim"],
          "schedule": {
            "cron": "0 3 * * *",
            "clock": "CLOCK_LOCAL"
          },
          "retention": {
            "policyTimeBucketed": {
              "daily": 14,
              "weekly": 4
            }
          },
          "backupFlags": ["--tag", "iac"],
          "commandPrefix": {
            "backup": ["ssh", "-o", "StrictHostKeyChecking=no", "root@10.10.0.175"]
          }
        },
        {
          "id": "synapse-daily",
          "repo": "garage-s3",
          "paths": ["/home", "/root", "/etc"],
          "excludes": ["/root/.cache", "/home/*/.cache", "/root/.local/share/nvim"],
          "schedule": {
            "cron": "30 3 * * *",
            "clock": "CLOCK_LOCAL"
          },
          "retention": {
            "policyTimeBucketed": {
              "daily": 14,
              "weekly": 4
            }
          },
          "backupFlags": ["--tag", "synapse"],
          "commandPrefix": {
            "backup": ["ssh", "-o", "StrictHostKeyChecking=no", "root@10.10.0.22"]
          }
        },
        {
          "id": "truenas-media-weekly",
          "repo": "garage-s3",
          "paths": ["/root"],
          "schedule": {
            "cron": "0 5 * * 0",
            "clock": "CLOCK_LOCAL"
          },
          "retention": {
            "policyTimeBucketed": {
              "weekly": 4,
              "monthly": 2
            }
          },
          "backupFlags": ["--tag", "truenas-media"],
          "commandPrefix": {
            "backup": ["ssh", "-o", "StrictHostKeyChecking=no", "root@10.20.0.100"]
          }
        },
        {
          "id": "truenas-hdd-weekly",
          "repo": "garage-s3",
          "paths": ["/root"],
          "schedule": {
            "cron": "0 6 * * 0",
            "clock": "CLOCK_LOCAL"
          },
          "retention": {
            "policyTimeBucketed": {
              "weekly": 4,
              "monthly": 2
            }
          },
          "backupFlags": ["--tag", "truenas-hdd"],
          "commandPrefix": {
            "backup": ["ssh", "-o", "StrictHostKeyChecking=no", "root@10.10.0.103"]
          }
        },
        {
          "id": "pdm-daily",
          "repo": "garage-s3",
          "paths": ["/etc", "/root"],
          "excludes": ["/root/.cache"],
          "schedule": {
            "cron": "45 3 * * *",
            "clock": "CLOCK_LOCAL"
          },
          "retention": {
            "policyTimeBucketed": {
              "daily": 7,
              "weekly": 4
            }
          },
          "backupFlags": ["--tag", "pdm"],
          "commandPrefix": {
            "backup": ["ssh", "-o", "StrictHostKeyChecking=no", "root@10.10.0.21"]
          }
        },
        {
          "id": "unifi-daily",
          "repo": "garage-s3",
          "paths": ["/root", "/etc"],
          "excludes": ["/root/.cache"],
          "schedule": {
            "cron": "15 4 * * *",
            "clock": "CLOCK_LOCAL"
          },
          "retention": {
            "policyTimeBucketed": {
              "daily": 7,
              "weekly": 4
            }
          },
          "backupFlags": ["--tag", "unifi"],
          "commandPrefix": {
            "backup": ["ssh", "-o", "StrictHostKeyChecking=no", "root@10.10.0.51"]
          }
        }
      ],
      "auth": {
        "users": [
          {
            "name": "chaz",
            "passwordBcrypt": "JDJhJDEwJFM0UGxTZkNHeVAydGJiMXdXcE81Qy5FYzR4Ry5RRHpYL0hXZVIwZHJZeHM1SmZ5YVdHLlNP"
          }
        ]
      }
    }
